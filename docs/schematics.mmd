%%{init: {"theme":"default","flowchart":{"defaultRenderer":"elk"}} }%%
flowchart LR
    %% POWER & FUSING
    subgraph PWR [Power & Fusing]
      BAT{{"+12V Battery"}}
      FUSE_MAIN["20A Main Fuse"]
      POWER_BUS["12V Power Bus"]
      FUSE_15A["15A Fuse Main Power"]
      FUSE_10A_GLOW["10A Fuse Glow Plugs"]
      FUSE_5A["5A Fuse Starter"]
      FUSE_10A_LIGHT["10A Fuse Lights"]
      GND[("Ground")]
      BAT --> FUSE_MAIN --> POWER_BUS
      POWER_BUS -->|Main power| FUSE_15A
    end

    %% MICROCONTROLLER & RELAYS
    subgraph CTRL ["LILYGO T-Relay ESP32 Board & Relays"]
      ESP32["ESP32-WROOM"]
      VIN["VIN (12V)"]
      ESP_GND[("Board GND")]
      REL1["Relay 1 Main Power<br/>GPIO21"]
      REL2["Relay 2 Glow Plugs<br/>GPIO19"]
      REL3["Relay 3 Starter<br/>GPIO18"]
      REL4["Relay 4 Lights<br/>GPIO5"]
      ESP32 -.->|WiFi| WEBAPP["Web UI 192.168.4.1"]
      VIN -.-> ESP32
      ESP_GND -.-> ESP32
      ESP32 -->|Control| REL1
      ESP32 -->|Control| REL2
      ESP32 -->|Control| REL3
      ESP32 -->|Control| REL4
    end
    
    %% SENSORS WITH ACTUAL GPIO PINS
    subgraph SENS ["Sensors & Signal Conditioning"]
      TEMP_SENSOR["Engine Temp NTC<br/>10kΩ @ 25°C"]
      TEMP_PU["10kΩ Pull-up to 3.3V"]
      OIL_SENDER["Oil Pressure Sender<br/>0-180Ω"]
      OIL_PU["220Ω Pull-up to 3.3V"]
      BAT_DIV_R1["Battery Voltage Divider<br/>100kΩ"]
      BAT_DIV_R2["33kΩ to GND"]
      ESP_3V3["ESP32 3.3V Rail"]
      FUEL_SENDER["Fuel Level Sender<br/>240-33Ω Float"]
      FUEL_PU["330Ω Pull-up to 3.3V"]
      HYD_SENDER["Hydraulic Pressure Sender<br/>0-180Ω"]
      HYD_PU["220Ω Pull-up to 3.3V"]
      ALT_SIGNAL["Alternator Charge"]
      ALT_PU["Internal Pull-up"]
      RUN_SIGNAL["Engine Run Feedback"]
      RUN_PU["Internal Pull-up"]
      
      TEMP_SENSOR --- TEMP_PU
      TEMP_PU -->|GPIO39 ADC1_CH3| ESP32
      OIL_SENDER --- OIL_PU
      OIL_PU -->|GPIO34 ADC1_CH6| ESP32
      POWER_BUS --- BAT_DIV_R1 --- BAT_DIV_R2
      BAT_DIV_R2 --- GND
      BAT_DIV_R1 -->|GPIO36 ADC1_CH0| ESP32
      ESP_3V3 -.-> TEMP_PU
      ESP_3V3 -.-> OIL_PU
      ESP_3V3 -.-> FUEL_PU
      ESP_3V3 -.-> HYD_PU
      FUEL_SENDER --- FUEL_PU
      FUEL_PU -->|GPIO35 ADC1_CH7| ESP32
      HYD_SENDER --- HYD_PU
      HYD_PU -->|GPIO33 ADC1_CH5| ESP32
      ALT_SIGNAL --- ALT_PU
      ALT_PU -->|GPIO22 Digital| ESP32
      RUN_SIGNAL --- RUN_PU
      RUN_PU -->|GPIO26 Digital| ESP32
    end

    %% OUTPUTS (BOBCAT ELECTRICAL)
    subgraph OUT ["Bobcat Engine & Electrical"]
      MAIN_DIST["Main Electrical Distribution"]
      GLOW_PLUGS["Glow Plug Bus Bar"]
      STARTER_SOL["Starter Solenoid<br/>(with flyback diode)"]
      WORK_LIGHTS["Work Lights<br/>(Front & Rear)"]
      
      FUSE_15A --> REL1
      REL1 -->|30A Switched 12V| MAIN_DIST
      POWER_BUS --> FUSE_10A_GLOW
      FUSE_10A_GLOW --> REL2
      REL2 -->|Switched 12V| GLOW_PLUGS
      POWER_BUS --> FUSE_5A
      FUSE_5A --> REL3
      REL3 -->|High Current| STARTER_SOL
      POWER_BUS --> FUSE_10A_LIGHT
      FUSE_10A_LIGHT --> REL4
      REL4 -->|Switched 12V| WORK_LIGHTS
    end

    %% MAIN POWER CONNECTIONS
    POWER_BUS --- VIN
    GND --- ESP_GND

    %% LEGEND & STYLING
    classDef power fill:#ffe6e6,stroke:#c00,stroke-width:2px;
    classDef sensor fill:#e6f0ff,stroke:#1e67b6,stroke-width:2px;
    classDef ctrl fill:#eaffea,stroke:#23a023,stroke-width:2px;
    classDef out fill:#fffccf,stroke:#bba900,stroke-width:2px;
    classDef fuse fill:#ffd0fa,stroke:#954ca4,stroke-width:2px;
    
    class BAT,FUSE_MAIN,POWER_BUS,GND,VIN,ESP_GND power;
    class FUSE_15A,FUSE_10A_GLOW,FUSE_5A,FUSE_10A_LIGHT fuse;
    class ESP32,REL1,REL2,REL3,REL4 ctrl;
    class TEMP_SENSOR,TEMP_PU,OIL_SENDER,OIL_PU,BAT_DIV_R1,BAT_DIV_R2,ESP_3V3,FUEL_SENDER,FUEL_PU,HYD_SENDER,HYD_PU,ALT_SIGNAL,ALT_PU,RUN_SIGNAL,RUN_PU sensor;
    class MAIN_DIST,GLOW_PLUGS,STARTER_SOL,WORK_LIGHTS out;
